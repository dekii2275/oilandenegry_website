"use client";

import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import { toast } from "react-hot-toast";
import {
  ProductDetail,
  Review,
  RelatedProduct,
  ReviewFilter,
  NewReview,
} from "../components/types";

import { useAuth } from "@/app/providers/AuthProvider";

// ðŸ‘‡ KHÃ”NG dÃ¹ng apiClient ná»¯a Ä‘á»ƒ trÃ¡nh lá»—i Axios khi build
// import { apiClient } from "@/lib/api-client";

export const useProductDetail = (productId: string) => {
  const router = useRouter();
  const { isAuthenticated, isLoading: authLoading } = useAuth();

  const [product, setProduct] = useState<ProductDetail | null>(null);
  const [reviews, setReviews] = useState<Review[]>([]);
  const [relatedProducts, setRelatedProducts] = useState<RelatedProduct[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // UI state
  const [selectedImage, setSelectedImage] = useState(0);
  const [quantity, setQuantity] = useState(1);
  const [activeTab, setActiveTab] = useState<
    "description" | "specs" | "reviews" | "shipping"
  >("description");
  const [showWriteReview, setShowWriteReview] = useState(false);
  const [newReview, setNewReview] = useState<NewReview>({
    title: "",
    comment: "",
    rating: 5,
  });
  const [reviewFilter, setReviewFilter] = useState<ReviewFilter>({
    rating: 0,
    sortBy: "newest",
  });
  const [displayedReviews, setDisplayedReviews] = useState(3);
  const [isInWishlist, setIsInWishlist] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const reviewsRef = useRef<HTMLDivElement>(null);

  // Láº¥y URL tá»« biáº¿n mÃ´i trÆ°á»ng hoáº·c fallback
  const baseUrl = process.env.NEXT_PUBLIC_API_URL?.trim() || "https://zenergy.cloud/api";

  // ============================================================================
  // 1. FETCH PRODUCT DETAIL (DÃ¹ng Fetch thuáº§n)
  // ============================================================================
  useEffect(() => {
    const fetchProductDetail = async () => {
      // Náº¿u khÃ´ng cÃ³ ID thÃ¬ thÃ´i
      if (!productId) return;

      try {
        setLoading(true);
        setError(null);

        // ðŸ‘‡ DÃ¹ng FETCH
        const res = await fetch(`${baseUrl}/products/${productId}`, {
            headers: { "Content-Type": "application/json" },
            // credentials: "include", // Náº¿u API public thÃ¬ khÃ´ng cáº§n dÃ²ng nÃ y
        });

        if (!res.ok) {
            if (res.status === 404) throw new Error("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m");
            throw new Error("Lá»—i káº¿t ná»‘i Server");
        }

        const data = await res.json();

        // ðŸ‘‡ Map dá»¯ liá»‡u (Khá»›p vá»›i cáº¥u trÃºc JSON tráº£ vá»)
        const productFromApi: ProductDetail = {
          id: data.id,
          name: data.name,
          brand: data.brand || data.store?.store_name || "No Brand",
          price: Number(data.price ?? data.variants?.[0]?.price ?? 0),
          oldPrice: Number(data.market_price ?? data.variants?.[0]?.market_price ?? 0),
          rating: data.rating_average || 0,
          reviewCount: data.review_count || 0,
          unit: data.unit || "cÃ¡i",
          totalReviews: data.review_count || 0,
          benefits: [],
          status: data.is_active ? "CÃ“ Sáº´N" : "Háº¾T HÃ€NG",
          // Xá»­ lÃ½ áº£nh: Backend cÃ³ thá»ƒ tráº£ vá» string hoáº·c array
          images: Array.isArray(data.images) 
            ? data.images 
            : (data.image_url ? [data.image_url] : ["https://via.placeholder.com/500"]),
          
          description: data.description || "Äang cáº­p nháº­t mÃ´ táº£...",
          
          technicalDetails: {
            brand: data.brand || "Äang cáº­p nháº­t",
            model: data.variants?.[0]?.sku || "N/A",
            warranty: data.warranty || "12 thÃ¡ng",
            origin: data.origin || "Viá»‡t Nam",
          },
          supplier: {
            id: data.store?.id || 1,
            name: data.store?.store_name || "Z-Energy Official",
            logo: "/images/default-store.png",
            slug: "z-energy-store",
          },
          specifications: data.specifications || {},
          features: ["Báº£o hÃ nh chÃ­nh hÃ£ng", "Giao hÃ ng toÃ n quá»‘c", "Há»— trá»£ ká»¹ thuáº­t 24/7"],
          sku: data.variants?.[0]?.sku || "N/A",
          category: data.category?.name || "CÃ´ng nghiá»‡p", // Sá»­a nháº¹ Ä‘á»ƒ láº¥y tÃªn category
        };

        setProduct(productFromApi);

        // Reset cÃ¡c state khÃ¡c
        setReviews([]);
        setRelatedProducts([]);
      } catch (err: any) {
        console.error("Lá»—i fetch detail:", err);
        setError(err.message || "KhÃ´ng thá»ƒ káº¿t ná»‘i Server");
      } finally {
        setLoading(false);
      }
    };

    fetchProductDetail();
  }, [productId, baseUrl]);

  // ---- auth helper ----
  const checkAuthAndRedirect = (actionType: "buy-now" | "add-to-cart" | "wishlist") => {
  if (authLoading) return false;

  const token =
    typeof window !== "undefined"
      ? localStorage.getItem("access_token") ||
        localStorage.getItem("accessToken") || // cÃ³ thá»ƒ báº¡n Ä‘ang lÆ°u camelCase
        localStorage.getItem("zenergy_token") ||
        localStorage.getItem("token") ||
        (() => {
          // fallback Ä‘á»c cookie accessToken (HttpOnly=false nÃªn Ä‘á»c Ä‘Æ°á»£c)
          const m = document.cookie.match(/(?:^|;\s*)accessToken=([^;]+)/);
          return m ? decodeURIComponent(m[1]) : "";
        })()
      : "";

  if (token) return true;

  if (typeof window !== "undefined" && product) {
    sessionStorage.setItem(
      "pendingAction",
      JSON.stringify({
        type: actionType,
        product: {
          id: product.id,
          name: product.name,
          price: product.price,
          quantity,
        },
        redirectUrl: window.location.href,
      })
    );
  }

  toast.error("Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c!", {
    duration: 4000,
    icon: "ðŸ”’",
  });

  if (typeof window !== "undefined") {
    router.push(`/login?redirect=${encodeURIComponent(window.location.href)}`);
  }

  return false;
};


  // ---- helper: get default variantId ----
  const getDefaultVariantId = async (pid: string) => {
    // DÃ¹ng fetch Ä‘á»ƒ láº¥y láº¡i variant ID
    const res = await fetch(`${baseUrl}/products/${pid}`);
    if(!res.ok) return undefined;
    
    const prodData = await res.json();
    const variantId =
      prodData?.variants?.[0]?.id ??
      prodData?.variants?.[0]?.variant_id ??
      prodData?.default_variant_id;
    return variantId as number | string | undefined;
  };

  // ============================================================================
  // 2. Add to cart (DÃ¹ng Fetch)
  // ============================================================================
  const handleAddToCart = async () => {
    if (authLoading) return;
    if (!checkAuthAndRedirect("add-to-cart")) return;

    if (!product) {
      toast.error("KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin sáº£n pháº©m!", { duration: 3500, icon: "âŒ" });
      return;
    }

    setIsLoading(true);
    try {
      const variantId = await getDefaultVariantId(String(product.id));
      if (!variantId) {
        return;
      }

      // ðŸ‘‡ DÃ¹ng FETCH POST (kÃ¨m credentials Ä‘á»ƒ gá»­i cookie)
      const res = await fetch(`${baseUrl}/cart/items`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include", // ðŸ‘ˆ QUAN TRá»ŒNG: Gá»­i cookie Auth
        body: JSON.stringify({ variant_id: variantId, quantity }),
      });

      if (!res.ok) {
        if (res.status === 401) throw new Error("Unauthorized");
        throw new Error("Failed to add to cart");
      }

      if (typeof window !== "undefined") window.dispatchEvent(new Event("cart-updated"));
      toast.success("ÄÃ£ thÃªm vÃ o giá» hÃ ng!", { duration: 2500, icon: "ðŸ›’" });
    } catch (err: any) {
      console.error("Lá»—i add-to-cart:", err);
      if (err.message === "Unauthorized") {
        toast.error("Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i!", { duration: 3500, icon: "ðŸ”’" });
        router.push("/login");
      } else {
        toast.error("CÃ³ lá»—i xáº£y ra khi thÃªm vÃ o giá» hÃ ng!", { duration: 4000, icon: "âŒ" });
      }
    } finally {
      setIsLoading(false);
    }
  };

  // ============================================================================
  // 3. Buy now (DÃ¹ng Fetch)
  // ============================================================================
  const handleRequestQuote = async () => {
    if (authLoading) return;
    if (!checkAuthAndRedirect("buy-now")) return;

    if (!product) return;

    setIsLoading(true);
    try {
      const variantId = await getDefaultVariantId(String(product.id));
      if (!variantId) {
        return;
      }

      const res = await fetch(`${baseUrl}/cart/items`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ variant_id: variantId, quantity }),
      });

      if (!res.ok) {
          if (res.status === 401) throw new Error("Unauthorized");
          throw new Error("Failed");
      }

      if (typeof window !== "undefined") window.dispatchEvent(new Event("cart-updated"));
      toast.success("ÄÃ£ thÃªm vÃ o giá» hÃ ng!", { duration: 2500, icon: "âœ…" });
      router.push("/cart/checkout");
    } catch (err: any) {
        console.error(err);
        if (err.message === "Unauthorized") router.push("/login");
        else toast.error("Lá»—i há»‡ thá»‘ng!", { duration: 4000, icon: "âŒ" });
    } finally {
      setIsLoading(false);
    }
  };

  // ============================================================================
  // 4. Wishlist (DÃ¹ng Fetch)
  // ============================================================================
  const handleToggleWishlist = async () => {
    if (authLoading) return;
    if (!checkAuthAndRedirect("wishlist")) return;
    if (!product) return;

    setIsLoading(true);
    try {
      if (isInWishlist) {
        // DELETE
        await fetch(`${baseUrl}/wishlist/remove?product_id=${product.id}`, {
            method: "DELETE",
            credentials: "include"
        });
        setIsInWishlist(false);
        toast.success("ÄÃ£ xÃ³a khá»i danh sÃ¡ch yÃªu thÃ­ch", { duration: 2500, icon: "ðŸ’”" });
      } else {
        // ADD
        await fetch(`${baseUrl}/wishlist/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
                product_id: product.id,
                product_name: product.name,
                price: product.price,
                image: product.images?.[0],
            })
        });
        setIsInWishlist(true);
        toast.success("ÄÃ£ thÃªm vÃ o danh sÃ¡ch yÃªu thÃ­ch", { duration: 2500, icon: "â¤ï¸" });
      }
    } catch (err: any) {
      console.error("Lá»—i wishlist:", err);
      toast.error("KhÃ´ng thá»ƒ thá»±c hiá»‡n thao tÃ¡c.", { duration: 3500, icon: "âŒ" });
    } finally {
      setIsLoading(false);
    }
  };

  // ---- UI helpers ----
  const handleQuantityChange = (type: "increase" | "decrease") => {
    if (type === "increase") setQuantity((prev) => prev + 1);
    else if (type === "decrease" && quantity > 1) setQuantity((prev) => prev - 1);
  };

  const handleSubmitReview = () => {
    toast.success("Cáº£m Æ¡n Ä‘Ã¡nh giÃ¡ cá»§a báº¡n!", { duration: 2500 });
    setShowWriteReview(false);
  };

  const loadMoreReviews = () => {
    setDisplayedReviews((prev) => prev + 3);
  };

  const handleReviewScroll = () => {};

  return {
    product,
    reviews,
    relatedProducts,
    loading,
    error,
    selectedImage,
    quantity,
    activeTab,
    showWriteReview,
    newReview,
    loadingMoreReviews: false,
    reviewFilter,
    displayedReviews,
    isInWishlist,
    isLoading,
    reviewsRef,

    setSelectedImage,
    handleQuantityChange,
    setActiveTab,
    setShowWriteReview,
    setNewReview,
    setReviewFilter,

    handleRequestQuote,
    handleAddToCart,
    handleToggleWishlist,
    loadMoreReviews,
    handleSubmitReview,
    handleReviewScroll,

    sortedReviewsLength: reviews.length,
  };
};